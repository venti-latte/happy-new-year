<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Happy New Year</title>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- ============================================ -->
    <!-- STYLES -->
    <!-- ============================================ -->
    <style>
        /* ========== Base Styles ========== */
        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: black;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            filter: contrast(120%);
        }

        /* ========== Instructions Overlay ========== */
        #instructions {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 40px 60px;
            border-radius: 15px;
            text-align: center;
            font-family: 'Caveat', cursive;
            font-size: 28px;
            z-index: 1000;
            border: 2px solid rgba(255, 255, 255, 0.3);
            line-height: 1.8;
        }

        #instructions.hidden {
            display: none;
        }

        #instructions p {
            margin: 15px 0;
        }

        #instructions .highlight {
            color: #88ccff;
            font-size: 32px;
        }

        /* ========== Container & Canvas ========== */
        .container {
            width: 100%;
            height: 100%;
            background-color: #000000;
        }

        .content {
            width: inherit;
            height: inherit;
        }

        #universe {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        #canvas {
            margin: 200px auto;
        }

        /* ========== Animations ========== */
        @keyframes rotate {
            0% {
                transform: rotate(0);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <!-- ============================================ -->
    <!-- HTML STRUCTURE -->
    <!-- ============================================ -->
    
    <!-- Background Music -->
    <audio src="https://github.com/venti-latte/happy-new-year/raw/refs/heads/main/bgmusic.mp3" id="mp3"
        loop="loop"></audio>
    
    <!-- Instructions Overlay -->
    <div id="instructions">
        <p class="highlight">Click anywhere to start reading.</p>
        <p>Use your left & right arrow keys to navigate</p>
        <p>Or click to advance the messages.</p>
    </div>
    
    <!-- Main Container -->
    <div class="container">
        <div class="content">
            <canvas id="universe"></canvas>
            <canvas id="canvas"></canvas>
        </div>
    </div>
    
    <!-- ============================================ -->
    <!-- JAVASCRIPT -->
    <!-- ============================================ -->
    <script>
        window.addEventListener('DOMContentLoaded', function () {
            
            /* ========================================== */
            /* MOUSE TRACKING */
            /* ========================================== */
            var mouse = { x: -1000, y: -1000 };
            window.addEventListener('mousemove', function (e) {
                mouse.x = e.clientX;
                mouse.y = e.clientY;
            });
            
            /* ========================================== */
            /* ANIMATION FRAME POLYFILL */
            /* ========================================== */
            window.requestAnimationFrame =
                window.requestAnimationFrame ||
                window.mozRequestAnimationFrame ||
                window.webkitRequestAnimationFrame ||
                window.msRequestAnimationFrame;
            
            /* ========================================== */
            /* AUDIO INITIALIZATION */
            /* ========================================== */
            const audio = document.getElementById('mp3');
            const instructions = document.getElementById('instructions');
            let unlocked = false;
            
            document.addEventListener('pointerdown', function unlockAudio() {
                if (unlocked) return;
                unlocked = true;
                audio.muted = false;
                audio.volume = 1;
                audio.loop = true;
                audio.play();
                instructions.classList.add('hidden');
            }, { once: true });
            
            /* ========================================== */
            /* UNIVERSE (STARFIELD) - CONFIGURATION */
            /* ========================================== */
            var starDensity = .35;
            var speedCoeff = .05;
            var width;
            var height;
            var starCount;
            var circleRadius;
            var circleCenter;
            var first = true;
            var giantColor = '255,255,255';
            var starColor = '255,255,255';
            var cometColor = '255,255,255';
            var canva = document.getElementById('universe');
            var stars = [];
            var universe;
            
            /* ========================================== */
            /* UNIVERSE - INITIALIZATION */
            /* ========================================== */
            windowResizeHandler();
            window.addEventListener('resize', windowResizeHandler, false);
            createUniverse();
            
            function createUniverse() {
                universe = canva.getContext('2d');
                for (var i = 0; i < starCount; i++) {
                    stars[i] = new Star();
                    stars[i].reset();
                }
                draw();
            }
            
            /* ========================================== */
            /* UNIVERSE - ANIMATION LOOP */
            /* ========================================== */
            function draw() {
                universe.clearRect(0, 0, width, height);
                var starsLength = stars.length;
                for (var i = 0; i < starsLength; i++) {
                    var star = stars[i];
                    star.move();
                    star.fadeIn();
                    star.fadeOut();
                    star.draw();
                }
                window.requestAnimationFrame(draw);
            }
            
            /* ========================================== */
            /* UNIVERSE - STAR CLASS */
            /* ========================================== */
            function Star() {
                // --- Star Reset/Initialization ---
                this.reset = function () {
                    this.giant = getProbability(3);
                    this.comet = this.giant || first ? false : getProbability(10);
                    this.x = Math.random() * width;
                    this.y = Math.random() * height;
                    this.r = getRandInterval(1.1, 2.6);
                    var angle = Math.random() * Math.PI * 2;
                    var speed = getRandInterval(speedCoeff, speedCoeff * 3);
                    this.dx = Math.cos(angle) * speed;
                    this.dy = Math.sin(angle) * speed;
                    if (this.comet) {
                        this.dx *= 120;
                        this.dy *= 1;
                    }
                    this.fadingOut = null;
                    this.fadingIn = true;
                    this.opacity = 0;
                    this.opacityTresh = getRandInterval(.2, 1.0);
                    this.do = getRandInterval(0.005, 0.01);
                };
                
                // --- Star Fade In ---
                this.fadeIn = function () {
                    if (this.fadingIn) {
                        this.fadingIn = this.opacity > this.opacityTresh ? false : true;
                        this.opacity += this.do;
                    }
                };
                
                // --- Star Fade Out ---
                this.fadeOut = function () {
                    if (this.fadingOut) {
                        this.fadingOut = this.opacity < 0 ? false : true;
                        this.opacity -= this.do / 2;
                        if (this.x > width || this.y < 0) {
                            this.fadingOut = false;
                            this.reset();
                        }
                    }
                };
                
                // --- Star Drawing ---
                this.draw = function () {
                    universe.beginPath();
                    universe.globalCompositeOperation = 'lighter';
                    
                    if (this.giant) {
                        // Draw giant star
                        universe.shadowBlur = this.r * 2;
                        universe.shadowColor = 'rgba(' + giantColor + ',' + this.opacity + ')';
                        var gradient = universe.createRadialGradient(this.x, this.y, 0, this.x, this.y, this.r * 2);
                        gradient.addColorStop(0, 'rgba(255, 255, 255, ' + this.opacity + ')');
                        gradient.addColorStop(0.5, 'rgba(' + giantColor + ',' + (this.opacity * 0.5) + ')');
                        gradient.addColorStop(1, 'rgba(' + giantColor + ', 0)');
                        universe.fillStyle = gradient;
                        universe.arc(this.x, this.y, this.r * 2, 0, 2 * Math.PI, false);
                        universe.fill();
                    } else if (this.comet) {
                        // Draw comet with tail
                        universe.shadowBlur = 0;
                        universe.beginPath();
                        var tailGradient = universe.createLinearGradient(this.x, this.y, this.x - this.dx * 15, this.y - this.dy * 15);
                        tailGradient.addColorStop(0, 'rgba(' + cometColor + ',' + this.opacity + ')');
                        tailGradient.addColorStop(1, 'rgba(' + cometColor + ', 0)');
                        universe.strokeStyle = tailGradient;
                        universe.lineWidth = this.r;
                        universe.lineCap = 'round';
                        universe.moveTo(this.x, this.y);
                        universe.lineTo(this.x - this.dx * 15, this.y - this.dy * 15);
                        universe.stroke();
                        universe.beginPath();
                        universe.fillStyle = 'rgba(' + cometColor + ',' + this.opacity + ')';
                        universe.arc(this.x, this.y, this.r, 0, 2 * Math.PI, false);
                        universe.fill();
                    } else {
                        // Draw regular star
                        universe.shadowBlur = 0;
                        var starGrad = universe.createRadialGradient(this.x, this.y, 0, this.x, this.y, this.r);
                        starGrad.addColorStop(0, 'rgba(255, 255, 255, ' + this.opacity + ')');
                        starGrad.addColorStop(1, 'rgba(' + starColor + ', 0)');
                        universe.fillStyle = starGrad;
                        universe.arc(this.x, this.y, this.r, 0, Math.PI * 2);
                        universe.fill();
                    }
                    universe.globalCompositeOperation = 'source-over';
                };
                
                // --- Star Movement with Mouse Interaction ---
                this.move = function () {
                    var w = window.innerWidth;
                    var h = window.innerHeight;
                    var dx = mouse.x - this.x;
                    var dy = mouse.y - this.y;
                    var distanceSq = dx * dx + dy * dy;
                    var distance = Math.sqrt(distanceSq);
                    var proximity = 100;
                    var gravityConstant = 0.98;
                    var friction = 0.98;
                    
                    if (distance < proximity) {
                        // Mouse is close - apply gravity and orbital motion
                        var force = gravityConstant / (distanceSq + 100);
                        this.dx += dx * force;
                        this.dy += dy * force;
                        var orbitStrength = 0.005;
                        this.dx += (dy / distance) * orbitStrength;
                        this.dy -= (dx / distance) * orbitStrength;
                        if (!this.comet) {
                            this.dx *= friction;
                            this.dy *= friction;
                        }
                    } else if (!this.comet) {
                        // Mouse is far - return to normal motion
                        var homeSpeedX = getRandInterval(-speedCoeff * 0, speedCoeff * 10);
                        var homeSpeedY = getRandInterval(-speedCoeff * 5, speedCoeff * 0);
                        this.dx += (homeSpeedX - this.dx) * 0;
                        this.dy += (homeSpeedY - this.dy) * 0;
                    }
                    
                    // Update position
                    this.x += this.dx;
                    this.y += this.dy;
                    
                    // Wrap around screen edges
                    if (this.x > w + 50) this.x = -50;
                    if (this.x < -50) this.x = w + 50;
                    if (this.y > h + 50) this.y = -50;
                    if (this.y < -50) this.y = h + 50;
                    
                    if (this.fadingOut === false) {
                        this.reset();
                    }
                };
                
                // --- Initial Setup ---
                (function () {
                    setTimeout(function () {
                        first = false;
                    }, 50)
                })()
            }
            
            /* ========================================== */
            /* UNIVERSE - UTILITY FUNCTIONS */
            /* ========================================== */
            function getProbability(percents) {
                return ((Math.floor(Math.random() * 1000) + 1) < percents * 10);
            }
            
            function getRandInterval(min, max) {
                return (Math.random() * (max - min) + min);
            }
            
            function windowResizeHandler() {
                width = window.innerWidth;
                height = window.innerHeight;
                starCount = width * starDensity;
                circleRadius = (width > height ? height / 2 : width / 2);
                circleCenter = { x: width / 2, y: height / 2 }
                canva.setAttribute('width', width);
                canva.setAttribute('height', height);
            }
            
            /* ========================================== */
            /* PARTICLE TEXT ANIMATION - MAIN MODULE */
            /* ========================================== */
            var Clock = (function () {
                var canvas, ctx, gradient, height = 400, particles = [], quiver = true,
                    texts = [
                        "Click me first.", "Hi Dan", "Happy New Year", "I hope you're doing well",
                        "And that you're happy", "I've been thinking", "A lot about you",
                        "Whenever I do", "I can't seem to get", "Any sleep", "Or even eat well",
                        "I always wonder", "How things would be", "If I never hurt you",
                        "Maybe we would be", "Greeting each other", "Happy New Year",
                        "Without the notion", "That it's just", "Out of politeness",
                        "But rather that", "We love each other", "I miss you", "So much",
                        "It's up to you", "If you choose", "To believe that", "I hurt you",
                        "After all", "But please", "Even though", "I've said this",
                        "Again and again", "I hope that", "You never doubt",
                        "That I still love you", "And if you", "Can't believe that",
                        "Then at least believe", "That I did love you", "At some point",
                        "I love you, Dan", "I always have", "I mean that", "And because",
                        "I love you", "I also want", "You to be happy", "Even if that's",
                        "Without me", "So if you want", "Me to let go", "I will",
                        "Even if I", "Don't want to", "Because your happiness",
                        "Matters to me", "You deserve everything", "I can offer to you",
                        "And more", "You deserve peace", "I'm sorry", "For all of it",
                        "I'm here if you need me", "And I'll leave you alone", "If you don't",
                        "Whatever you need", "I love you", "Always"
                    ],
                    text = texts[0], textNum = 0, textSize = 100, updateColor = true, width = 420;
                
                var FRAME_RATE = 16, MIN_WIDTH = 0, MIN_HEIGHT = 0, PARTICLE_NUM = 3000, RADIUS = Math.PI * 2;
                
                // --- Draw Single Particle ---
                var draw = function (p) {
                    ctx.fillStyle = 'rgba(255,255,255, ' + p.opacity + ')';
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.size, 0, RADIUS, true);
                    ctx.closePath();
                    ctx.fill();
                };
                
                // --- Main Animation Loop ---
                var loop = function () {
                    ctx.clearRect(0, 0, width, height);
                    ctx.fillStyle = "rgb(255, 255, 255)";
                    ctx.textBaseline = "middle";
                    ctx.font = textSize + "px 'Caveat', cursive";
                    ctx.fillText(text, (width - ctx.measureText(text).width) * 0.5, height * 0.5);
                    var imgData = ctx.getImageData(0, 0, width, height);
                    ctx.clearRect(0, 0, width, height);
                    
                    for (var i = 0, l = particles.length; i < l; i++) {
                        var p = particles[i];
                        p.inText = false;
                    }
                    particleText(imgData);
                };
                
                // --- Particle Text Formation ---
                var particleText = function (imgData) {
                    var pxls = [];
                    for (var w = width; w > 0; w -= 3) {
                        for (var h = 0; h < width; h += 3) {
                            var index = (w + h * (width)) * 4;
                            if (imgData.data[index] > 1) {
                                pxls.push([w, h]);
                            }
                        }
                    }
                    
                    var count = pxls.length;
                    var j = parseInt((particles.length - pxls.length) / 2, 10)
                    if (j < 0) j = 0;
                    
                    // Move particles to text positions
                    for (var i = 0; i < pxls.length && j < particles.length; i++, j++) {
                        try {
                            var p = particles[j];
                            var targetX, targetY;
                            
                            if (quiver) {
                                var time = Date.now() * 0.001;
                                targetX = pxls[count - 1][0] + (Math.sin(time + p.x * 0.5) * 1.5);
                                targetY = pxls[count - 1][1] + (Math.cos(time + p.y * 0.5) * 1.5);
                            } else {
                                targetX = pxls[count - 1][0];
                                targetY = pxls[count - 1][1];
                            }
                            
                            var ease = 0.02;
                            p.px += (targetX - p.px) * ease;
                            p.py += (targetY - p.py) * ease;
                            p.x = p.px;
                            p.y = p.py;
                            p.inText = true;
                            p.fadeIn();
                            draw(p);
                            count--;
                        } catch (e) { }
                    }
                    
                    // Handle particles not in text
                    for (var i = 0; i < particles.length; i++) {
                        var p = particles[i];
                        if (!p.inText) {
                            p.fadeOut();
                            var X = p.mx - p.px;
                            Y = p.my - p.py;
                            var T = Math.sqrt(X * X + Y * Y);
                            var A = Math.atan2(Y, X);
                            var C = Math.cos(A);
                            var S = Math.sin(A);
                            p.x = p.px + C * T * p.delta / 2;
                            p.y = p.py + S * T * p.delta / 2;
                            p.px = p.x;
                            p.py = p.y;
                            draw(p);
                        }
                    }
                };
                
                // --- Canvas Dimensions Setup ---
                var setDimensions = function () {
                    canvas.width = window.innerWidth >= 1800 ? 800 : window.innerWidth * 0.9;
                    canvas.height = 200;
                    width = canvas.width;
                    height = canvas.height;
                    canvas.style.position = 'absolute';
                    canvas.style.left = '50%';
                    canvas.style.top = '50%';
                    canvas.style.transform = 'translate(-50%, -50%)';
                    canvas.style.marginTop = '0px';
                };
                
                // --- Public API ---
                return {
                    init: function (canvasID) {
                        canvas = document.getElementById(canvasID);
                        if (canvas === null || !canvas.getContext) return;
                        ctx = canvas.getContext("2d");
                        setDimensions();
                        this.event();
                        
                        for (var i = 0; i < PARTICLE_NUM; i++) {
                            particles[i] = new Particle(canvas);
                        }
                        
                        var runLoop = function () {
                            loop();
                            requestAnimationFrame(runLoop);
                        };
                        requestAnimationFrame(runLoop);
                    },
                    
                    // --- Event Handlers ---
                    event: function () {
                        // Click to advance text
                        document.addEventListener('click', function (e) {
                            textNum++;
                            particles.forEach(function (p) {
                                var angle = Math.random() * Math.PI * 2;
                                var push = Math.random() * 10;
                                p.px += Math.cos(angle) * push;
                                p.py += Math.sin(angle) * push;
                            });
                            if (textNum >= texts.length) {
                                textNum = texts.length - 1;
                                return;
                            }
                            text = texts[textNum];
                        }, false);
                        
                        // Keyboard navigation
                        document.addEventListener('keydown', function (e) {
                            if (e.key === 'ArrowRight' || e.keyCode === 39) {
                                textNum++;
                                if (textNum >= texts.length) textNum = texts.length - 1;
                                text = texts[textNum];
                            } else if (e.key === 'ArrowLeft' || e.keyCode === 37) {
                                textNum--;
                                if (textNum < 0) textNum = 0;
                                text = texts[textNum];
                            }
                        }, false);
                    }
                };
            })();
            
            /* ========================================== */
            /* PARTICLE CLASS */
            /* ========================================== */
            var Particle = function (canvas) {
                var spread = canvas.height / 4, size = Math.random() * 1.2;
                this.delta = 0.005;
                this.x = 0; this.y = 0;
                this.px = (canvas.width / 2) + ((Math.random() - 0.5) * canvas.width);
                this.py = (canvas.height * 0.5) + ((Math.random() - 0.5) * spread);
                this.mx = this.px; this.my = this.py;
                this.size = size;
                this.inText = false;
                this.opacity = 0;
                this.do = 0.04;
                this.opacityTresh = 1.0;
                this.fadingOut = true;
                this.fadingIn = true;
                
                this.fadeIn = function () {
                    this.fadingIn = this.opacity > this.opacityTresh ? false : true;
                    if (this.fadingIn) this.opacity += this.do;
                    else this.opacity = 1;
                };
                
                this.fadeOut = function () {
                    this.fadingOut = this.opacity < 0 ? false : true;
                    if (this.fadingOut) {
                        this.opacity -= 0.06;
                        if (this.opacity < 0) this.opacity = 0;
                    } else this.opacity = 0;
                };
            };
            
            /* ========================================== */
            /* AUDIO START FALLBACK */
            /* ========================================== */
            var audioStarted = false;
            document.addEventListener('click', () => {
                if (!audioStarted) {
                    var mp3 = document.getElementById('mp3');
                    mp3.play().catch(err => console.log(err));
                    audioStarted = true;
                    document.getElementById('instructions').classList.add('hidden');
                }
            }, { once: true });
            
            /* ========================================== */
            /* INITIALIZE PARTICLE TEXT */
            /* ========================================== */
            setTimeout(() => Clock.init('canvas'), 2000);
        });
    </script>
</body>

</html>
