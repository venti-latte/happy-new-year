<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Happy New Year</title>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Base Styles */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: black;
        }
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            filter: contrast(120%);
        }
        /* Instructions */
        #instructions {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 40px 60px;
            border-radius: 15px;
            text-align: center;
            font-family: 'Caveat', cursive;
            font-size: 28px;
            z-index: 1000;
            border: 2px solid rgba(255, 255, 255, 0.3);
            line-height: 1.8;
        }
        #instructions.hidden {
            display: none;
        }
        #instructions p {
            margin: 15px 0;
        }
        #instructions .highlight {
            color: #88ccff;
            font-size: 32px;
        }
        /* Container */
        .container {
            width: 100%;
            height: 100%;
            background-color: #000000;
        }
        .content {
            width: inherit;
            height: inherit;
        }
        /* Canvas */
        #universe {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }
        #canvas {
            margin: 200px auto;
        }
        /* Animations */
        @keyframes rotate {
            0% { transform: rotate(0); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Music Placeholder -->
    <audio src="https://github.com/venti-latte/happy-new-year/raw/refs/heads/main/bgmusic.mp3" id="mp3" loop="loop"></audio>
    
    <!-- Instructions -->
    <div id="instructions">
        <p class="highlight">Click anywhere to start reading.</p>
        <p>Use your left & right arrow keys to navigate</p>
        <p>Or click to advance the messages.</p>
    </div>
    
    <div class="container">
        <div class="content">
            <canvas id="universe"></canvas>
            <canvas id="canvas"></canvas>
        </div>
    </div>

    <script>
window.addEventListener('DOMContentLoaded', function () {

  /* ===============================
     REQUEST ANIMATION FRAME
  =============================== */
  window.requestAnimationFrame =
    window.requestAnimationFrame ||
    window.mozRequestAnimationFrame ||
    window.webkitRequestAnimationFrame ||
    window.msRequestAnimationFrame;

  /* ===============================
     AUDIO + INSTRUCTIONS CONTROL
  =============================== */
const audio = document.getElementById('mp3');
const instructions = document.getElementById('instructions');

let unlocked = false;

document.addEventListener('pointerdown', function unlockAudio() {
  if (unlocked) return;
  unlocked = true;

  // MUST be first line
  audio.muted = false;
  audio.volume = 1;
  audio.loop = true;

  audio.play();

  instructions.classList.add('hidden');

}, { once: true });

            // Universe (Stars) Variables
            var starDensity = .255;
            var speedCoeff = .05;
            var width;
            var height;
            var starCount;
            var circleRadius;
            var circleCenter;
            var first = true;
            var giantColor = '255,255,255';
            var starColor = '255,255,255';
            var cometColor = '255,255,255';
            var canva = document.getElementById('universe');
            var stars = [];
            var universe;

            // Initialize Universe
            windowResizeHandler();
            window.addEventListener('resize', windowResizeHandler, false);
            createUniverse();

            function createUniverse() {
              universe = canva.getContext('2d');

              for (var i = 0; i < starCount; i++) {
                stars[i] = new Star();
                stars[i].reset();
              }

              draw();
            }

            function draw() {
              universe.clearRect(0, 0, width, height);

              var starsLength = stars.length;

              for (var i = 0; i < starsLength; i++) {
                var star = stars[i];
                star.move();
                star.fadeIn();
                star.fadeOut();
                star.draw();
              }

              window.requestAnimationFrame(draw);
            }

            function Star() {

              this.reset = function() {
                this.giant = getProbability(3);
                this.comet = this.giant || first ? false : getProbability(10);
                this.x = getRandInterval(0, width - 10);
                this.y = getRandInterval(0, height);
                this.r = getRandInterval(1.1, 2.6);
                this.dx = getRandInterval(speedCoeff, 6 * speedCoeff) + (this.comet + 1 - 1) * speedCoeff * getRandInterval(50, 120) + speedCoeff * 2;
                this.dy = -getRandInterval(speedCoeff, 6 * speedCoeff) - (this.comet + 1 - 1) * speedCoeff * getRandInterval(50, 120);
                this.fadingOut = null;
                this.fadingIn = true;
                this.opacity = 0;
                this.opacityTresh = getRandInterval(.2, 1 - (this.comet + 1 - 1) * .4);
                this.do = getRandInterval(0.0005, 0.002) + (this.comet + 1 - 1) * .001;
              };

              this.fadeIn = function() {
                if (this.fadingIn) {
                  this.fadingIn = this.opacity > this.opacityTresh ? false : true;
                  this.opacity += this.do;
                }
              };

              this.fadeOut = function() {
                if (this.fadingOut) {
                  this.fadingOut = this.opacity < 0 ? false : true;
                  this.opacity -= this.do / 2;
                  if (this.x > width || this.y < 0) {
                    this.fadingOut = false;
                    this.reset();
                  }
                }
              };

              this.draw = function() {
                universe.beginPath();

                if (this.giant) {
                  universe.fillStyle = 'rgba(' + giantColor + ',' + this.opacity + ')';
                  universe.arc(this.x, this.y, 2, 0, 2 * Math.PI, false);
                } else if (this.comet) {
                  universe.fillStyle = 'rgba(' + cometColor + ',' + this.opacity + ')';
                  universe.arc(this.x, this.y, 1.5, 0, 2 * Math.PI, false);

                  // Comet tail
                  for (var i = 0; i < 30; i++) {
                    universe.fillStyle = 'rgba(' + cometColor + ',' + (this.opacity - (this.opacity / 20) * i) + ')';
                    universe.rect(this.x - this.dx / 4 * i, this.y - this.dy / 4 * i - 2, 2, 2);
                    universe.fill();
                  }
                } else {
                  universe.fillStyle = 'rgba(' + starColor + ',' + this.opacity + ')';
                  universe.rect(this.x, this.y, this.r, this.r);
                }

                universe.closePath();
                universe.fill();
              };

              this.move = function() {
                this.x += this.dx;
                this.y += this.dy;
                if (this.fadingOut === false) {
                  this.reset();
                }
                if (this.x > width - (width / 4) || this.y < 0) {
                  this.fadingOut = true;
                }
              };

              (function() {
                setTimeout(function() {
                  first = false;
                }, 50)
              })()
            }

            function getProbability(percents) {
              return ((Math.floor(Math.random() * 1000) + 1) < percents * 10);
            }

            function getRandInterval(min, max) {
              return (Math.random() * (max - min) + min);
            }

            function windowResizeHandler() {
              width = window.innerWidth;
              height = window.innerHeight;
              starCount = width * starDensity;
              circleRadius = (width > height ? height / 2 : width / 2);
              circleCenter = {
                x: width / 2,
                y: height / 2
              }

              canva.setAttribute('width', width);
              canva.setAttribute('height', height);
            }

            // Clock (Particle Text) Module
            var Clock = (function() {
                var canvas,
                    ctx,
                    gradient, 
                    height = 400,
                    particles = [],
                    quiver = true, 
                    texts = [
                "Click me first.",
                "Hi Dan",
                "Happy New Year",
                "I hope you're doing well",
                "And that you're happy",
                "I've been thinking",
                "A lot about you",
                "Whenever I do",
                "I can't seem to get",
                "Any sleep",
                "Or even eat well",
                "I always wonder",
                "How things would be",
                "If I never hurt you",
                "Maybe we would be",
                "Greeting each other",
                "Happy New Year",
                "Without the notion",
                "That it's just",
                "Out of politeness",
                "But rather that",
                "We love each other",
                "I miss you",
                "So much",
                "It's up to you",
                "If you choose",
                "To believe that",
                "I hurt you",
                "After all",
                "But please",
                "Even though",
                "I've said this",
                "Again and again",
                "I hope that",
                "You never doubt",
                "That I still love you",
                "And if you",
                "Can't believe that",
                "Then at least believe",
                "That I did love you",
                "At some point",
                "I love you, Dan",
                "I always have",
                "I mean that",
                "And because",
                "I love you",
                "I also want",
                "You to be happy",
                "Even if that's",
                "Without me",
                "So if you want",
                "Me to let go",
                "I will",
                "Even if I",
                "Don't want to",
                "Because your happiness",
                "Matters to me",
                "You deserve everything",
                "I can offer to you",
                "And more",
                "You deserve peace",
                "I'm sorry",
                "For all of it",
                "I'm here if you need me",
                "And I'll leave you alone",
                "If you don't",
                "Whatever you need",
                "I love you",
                "Always"
            ],
                    text = texts[0],
                    textNum = 0,
                    textSize = 100, 
                    updateColor = true, 
                    width = 420; 
                
                var FRAME_RATE = 60, 
                    MIN_WIDTH = 0, 
                    MIN_HEIGHT = 0, 
                    PARTICLE_NUM = 3000, 
                    RADIUS = Math.PI * 2; 

                var draw = function(p) {
                    ctx.fillStyle = 'rgba(255,255,255, ' + p.opacity + ')';
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.size, 0, RADIUS, true);
                    ctx.closePath();
                    ctx.fill();
                };
                
                var loop = function() {
                    ctx.clearRect(0, 0, width, height);

                    var gradient = ctx.createLinearGradient(0, 0, width, 0);
                    gradient.addColorStop(0, "rgb(200, 255, 255)");
                    gradient.addColorStop(0.5, "rgb(230, 250, 255)");
                    gradient.addColorStop(1, "rgb(255, 255, 255)");
                  
                    ctx.fillStyle = "rgb(255, 255, 255)";
                    ctx.textBaseline = "middle";
                    ctx.font = textSize + "px 'Caveat', cursive";
                    ctx.fillText(text, (width - ctx.measureText(text).width) * 0.5, height * 0.5);

                    var imgData = ctx.getImageData(0, 0, width, height);
                    
                    ctx.clearRect(0, 0, width, height);

                    for (var i = 0, l = particles.length; i < l; i++) {
                        var p = particles[i];
                        p.inText = false;
                    }
                    particleText(imgData);
                };

                var particleText = function(imgData) {
                    var pxls = [];
                    for (var w = width; w > 0; w -= 3) {
                        for (var h = 0; h < width; h += 3) {
                            var index = (w + h * (width)) * 4;
                            if (imgData.data[index] > 1) {
                                pxls.push([w, h]);
                            }
                        }
                    }

                    var count = pxls.length;
                    var j = parseInt((particles.length - pxls.length) / 2, 10)
                    if (j < 0) {
                        j = 0;
                    }

                    for (var i = 0; i < pxls.length && j < particles.length; i++, j++) {
                        try {
                            var p = particles[j],
                                X,
                                Y;

                            if (quiver) { 
                                X = (pxls[count - 1][0]) - (p.px + Math.random() * 5);
                                Y = (pxls[count - 1][1]) - (p.py + Math.random() * 5);
                            } else {
                                X = (pxls[count - 1][0]) - p.px;
                                Y = (pxls[count - 1][1]) - p.py;
                            }
                            var T = Math.sqrt(X * X + Y * Y);
                            var A = Math.atan2(Y, X);
                            var C = Math.cos(A);
                            var S = Math.sin(A);
                            p.x = p.px + C * T * p.delta;
                            p.y = p.py + S * T * p.delta;
                            p.px = p.x;
                            p.py = p.y;
                            p.inText = true;
                            p.fadeIn();
                            draw(p);
                        } catch (e) {
                            
                        }
                        count--;
                    }
                    
                    for (var i = 0; i < particles.length; i++) {
                        var p = particles[i];
                        if (!p.inText) {
                            p.fadeOut();

                            var X = p.mx - p.px;
                            Y = p.my - p.py;
                            var T = Math.sqrt(X * X + Y * Y);
                            var A = Math.atan2(Y, X);
                            var C = Math.cos(A);
                            var S = Math.sin(A);

                            p.x = p.px + C * T * p.delta / 2;
                            p.y = p.py + S * T * p.delta / 2;
                            p.px = p.x;
                            p.py = p.y;

                            draw(p);
                        }
                    }
                };

                var setDimensions = function() {
                    canvas.width = window.innerWidth >= 1800 ? 800 : window.innerWidth * 0.9;
                    canvas.height = 200;

                    width = canvas.width;
                    height = canvas.height;

                    canvas.style.position = 'absolute';
                    canvas.style.left = '50%';
                    canvas.style.top = '50%';
                    canvas.style.transform = 'translate(-50%, -50%)';
                    canvas.style.marginTop = '0px';
                };

                var setGradient = function(gradientStops) {
                    gradient = ctx.createRadialGradient(width / 2, height / 2, 0, width / 2, height / 2, width);

                    for (var position in gradientStops) {
                        var color = gradientStops[position];
                        gradient.addColorStop(position, color);
                    }
                };

                return {
                    init: function(canvasID) {
                        canvas = document.getElementById(canvasID);
                        if (canvas === null || !canvas.getContext) {
                            return;
                        }
                        ctx = canvas.getContext("2d");
                        setDimensions();
                        this.event();

                        for (var i = 0; i < PARTICLE_NUM; i++) {
                            particles[i] = new Particle(canvas);
                        }

                        setInterval(loop, FRAME_RATE);
                    },

                    event: function() {
                        var end = false;
                        console.log(texts.length);
                        
                        // Click to advance
                        document.addEventListener('click', function(e) {
                            textNum++;
                            if (textNum >= texts.length) {
                                textNum = texts.length - 1;
                                end = true;
                                return;
                            }
                            text = texts[textNum];
                            console.log(textNum);
                        }, false);
                        
                        // Arrow keys to navigate
                        document.addEventListener('keydown', function(e) {
                            if (e.key === 'ArrowRight' || e.keyCode === 39) {
                                textNum++;
                                if (textNum >= texts.length) {
                                    textNum = texts.length - 1;
                                }
                                text = texts[textNum];
                                console.log('Forward:', textNum);
                            } else if (e.key === 'ArrowLeft' || e.keyCode === 37) {
                                textNum--;
                                if (textNum < 0) {
                                    textNum = 0;
                                }
                                text = texts[textNum];
                                console.log('Back:', textNum);
                            }
                        }, false);
                    }
                };
            })();

            // Particle Constructor
            var Particle = function(canvas) {
                var range = Math.random() * 180 / Math.PI, 
                    spread = canvas.height / 4, 
                    size = Math.random() * 1.2; 

                this.delta = 0.15;
                this.x = 0;
                this.y = 0;
                
                this.px = (canvas.width / 2) + ((Math.random() - 0.5) * canvas.width);
                this.py = (canvas.height * 0.5) + ((Math.random() - 0.5) * spread);

                this.mx = this.px;
                this.my = this.py;

                this.velocityX = Math.floor(Math.random() * 10) - 5;
                this.velocityY = Math.floor(Math.random() * 10) - 5;

                this.size = size;
                this.origSize = size;

                this.inText = false;

                this.opacity = 0;
                this.do = 0.04;

                this.opacityTresh = 1.0
                this.fadingOut = true;
                this.fadingIn = true;
                
                this.fadeIn = function() {
                    this.fadingIn = this.opacity > this.opacityTresh ? false : true;
                    if (this.fadingIn) {
                        this.opacity += this.do;
                    } else {
                        this.opacity = 1;
                    }
                };

                this.fadeOut = function() {
                    this.fadingOut = this.opacity < 0 ? false : true;
                    if (this.fadingOut) {
                        this.opacity -= 0.06;
                        if (this.opacity < 0) {
                            this.opacity = 0
                        }
                    } else {
                        this.opacity = 0
                    }
                };
            };

            // Audio initialization
            var audioStarted = false;
            document.addEventListener('click', () => {
              if (!audioStarted) {
                var mp3 = document.getElementById('mp3');
                mp3.play().catch(function(err) {
                  console.log('Audio play failed:', err);
                });
                audioStarted = true;
                
                // Hide instructions
                document.getElementById('instructions').classList.add('hidden');
              }
            }, { once: true });

            // Start Clock animation
            setTimeout(function() {
                Clock.init('canvas');
            }, 2000);
        });
    </script>
</body>
</html>
